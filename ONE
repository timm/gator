#!/usr/bin/env bash

here=$(cd $( dirname "${BASH_SOURCE[0]}" ) && pwd )
chmod +x $here/ONE
chmod +x $here/ALL

for c in sbcl rlwrap gawk; do
  if [ -z `which $c` ]; then
     >&2 echo "# W: please install $c"
  fi
done


sbcl() {
  rlwrap $(which sbcl) --noinform
}

lisp() {
  local b4=$PWD
  cd $(dirname $1) 
  local f=$(basename $1)
  shift
  $(which sbcl) --script $f $* 2> >(gawk '      {print} 
                                          /^5:/ {exit}')
  cd $b4
}
(cd $here/src
for f in $(find . -type f  -name "[[:lower:]]*.lisp"); do
  g=$here/docs/${f%.*}.md
 if [ "$f" -nt "$g" ]; then
    echo "f $f g $g"
    mkdir -p $(dirname $g)
    cat $f | gawk  '
      BEGIN         { Code=0 }
      sub(/#\|/,"") { if(Code) print("```"); Code=0; print $0; next }
      sub(/\|#/,"") { Code=1; print("```lisp"); print $0; next }
                    { print }
      END           { if(Code) print "```" }
      ' > $g
  fi
done
)


want=$here/.gitignore
[ -f "$want" ] || cat<<'EOF'>$want
# Swap
[._]*.s[a-v][a-z]
!*.svg  # comment out if you don't need vector files
[._]*.sw[a-p]
[._]s[a-rt-v][a-z]
[._]ss[a-gi-z]
[._]sw[a-p]

# Session
Session.vim
Sessionx.vim

# Temporary
.netrwhist
*~
# Auto-generated tag files
tags
# Persistent undo
[._]*.un~

.DS_Store
EOF

want=$here/.travis.yml
[ -f "$want" ] || cat<<'EOF'>$want
language: common-lisp
sudo: required

env:
  matrix:
    - LISP=sbcl
    - LISP=clisp

install:
  # Install cl-travis
  - curl https://raw.githubusercontent.com/luismbo/cl-travis/master/install.sh | bash

script:
  - cd src
  - sbcl --script yes_my.lisp

notifications:
  email:
    - timm@ieee.org
EOF
